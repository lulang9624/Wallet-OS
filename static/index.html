<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallos Next</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Wallet OS</h1>
        
        <!-- 统计展示区域 -->
        <!-- Statistics display area -->
        <div class="stats-grid">
            <div class="stat-box">
                <h3>Total Monthly</h3>
                <div class="value" id="total-cost">...</div>
            </div>
            <div class="stat-box">
                <h3>Active Subs</h3>
                <div class="value" id="active-count">...</div>
            </div>
        </div>

        <div style="text-align: right; margin-bottom: 20px;">
            <button class="btn" onclick="openModal()">+ Add Subscription</button>
        </div>
        <!-- 订阅列表容器 -->
        <!-- Subscription list container -->
        <div id="subs-list">Loading...</div>
    </div>

    <!-- 添加订阅的模态框 -->
    <!-- Add subscription modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2>New Subscription</h2>
            <input type="text" id="name" placeholder="Name (e.g. Netflix)" oninput="clearError()">
            <div id="name-error" class="error-msg">Name is required</div>
            <input type="number" id="price" placeholder="Price">
            <input type="text" id="currency" value="CNY" placeholder="Currency">
            <select id="frequency">
                <option value="1">Monthly</option>
                <option value="12">Yearly</option>
            </select>
            <input type="date" id="next_payment">
            <button class="btn" onclick="addSubscription()">Save</button>
            <button class="btn" style="background: #666;" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <!-- Delete confirmation modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2>Delete Subscription</h2>
            <p>To confirm deletion, type <strong id="delete-match-name" style="color: var(--accent);"></strong> below:</p>
            <input type="text" id="delete-confirm-input" placeholder="Type subscription name">
            <div style="text-align: right; margin-top: 15px;">
                <button id="btn-confirm-delete" class="btn" style="background: #f44336; opacity: 0.5; cursor: not-allowed;" disabled onclick="executeDelete()">Delete</button>
                <button class="btn" style="background: #666;" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API = '/api/subscriptions';
        let currentSubs = []; // Store current subscriptions globally

        // 获取并渲染订阅列表
        // Fetch and render subscription list
        async function fetchSubs() {
            const res = await fetch(API);
            const data = await res.json();
            currentSubs = data; // Save data
            renderStats(data);
            const list = document.getElementById('subs-list');
            list.innerHTML = '';
            data.forEach(sub => {
                let freqLabel = sub.frequency === 12 ? '/yr' : '/mo';
                
                // 计算电池状态
                // Calculate battery status
                const batteryHtml = getBatteryHtml(sub.next_payment, sub.frequency);

                list.innerHTML += `
                    <div class="sub-card">
                        <div class="sub-info">
                            <div style="display:flex;align-items:center;">
                                <h3>${sub.name}</h3>
                                ${batteryHtml}
                            </div>
                            <small>Next: ${sub.next_payment || 'N/A'}</small>
                        </div>
                        <div style="text-align: right;">
                            <div class="sub-price">${sub.currency} ${sub.price}<span style="font-size:0.8rem;color:#aaa">${freqLabel}</span></div>
                            <button style="background:none; border:none; color:#f44336; cursor:pointer;" onclick="openDeleteModal(${sub.id})">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            // 触发动画
            // Trigger animation
            setTimeout(() => {
                document.querySelectorAll('.battery-level').forEach(el => {
                    el.style.width = el.getAttribute('data-width');
                });
            }, 100);
        }

        // 计算电池 HTML
        // Calculate Battery HTML
        function getBatteryHtml(nextDateStr, frequency) {
            if (!nextDateStr) return '';
            
            const nextDate = new Date(nextDateStr);
            const now = new Date();
            
            // 重置时间部分，只比较日期
            // Reset time part, only compare dates
            nextDate.setHours(0,0,0,0);
            now.setHours(0,0,0,0);

            let diffTime = nextDate - now;
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // 如果过期了
            // If overdue
            if (diffDays < 0) {
                return `
                    <div class="battery-container" title="Overdue">
                        <div class="battery" style="border-color: #666;">
                            <div class="battery-level" style="width: 0%; background: #666;" data-width="0%"></div>
                        </div>
                        <span class="days-left" style="color:#666">Exp</span>
                    </div>
                `;
            }

            // 计算周期长度（天）
            // Calculate cycle length (days)
            // 简单处理：月付30天，年付365天
            // Simple logic: Monthly 30 days, Yearly 365 days
            const cycleDays = frequency === 12 ? 365 : 30;
            
            // 计算百分比 (剩余天数 / 周期)
            // Calculate percentage (days left / cycle)
            let percentage = (diffDays / cycleDays) * 100;
            if (percentage > 100) percentage = 100; // 防止刚续费显示溢出
            
            // 确定颜色
            // Determine color
            let color = '#4caf50'; // Green
            if (percentage < 20) {
                color = '#f44336'; // Red
            } else if (percentage < 50) {
                color = '#ff9800'; // Orange
            }

            return `
                <div class="battery-container" title="${diffDays} days left">
                    <div class="battery">
                        <div class="battery-level" style="background: ${color}; width: 0%" data-width="${percentage}%"></div>
                    </div>
                    <span class="days-left">${diffDays}d</span>
                </div>
            `;
        }

        // 计算并显示统计数据
        // Calculate and display statistics
        function renderStats(subs) {
            let total = 0;
            let currency = subs.length > 0 ? subs[0].currency : 'CNY';
            
            subs.forEach(sub => {
                // 如果是年付，转换为月均成本
                // If yearly payment, convert to monthly cost
                if(sub.frequency === 12) {
                    total += sub.price / 12;
                } else {
                    total += sub.price;
                }
            });
            document.getElementById('total-cost').innerText = currency + ' ' + total.toFixed(2);
            document.getElementById('active-count').innerText = subs.length;
        }

        // 添加新订阅
        // Add new subscription
        async function addSubscription() {
            const nameInput = document.getElementById('name');
            const errorMsg = document.getElementById('name-error');
            const name = nameInput.value;
            
            if (!name || name.trim() === '') {
                nameInput.classList.add('input-error');
                errorMsg.style.display = 'block';
                return;
            }

            const payload = {
                name: name,
                price: parseFloat(document.getElementById('price').value),
                currency: document.getElementById('currency').value,
                next_payment: document.getElementById('next_payment').value,
                frequency: parseInt(document.getElementById('frequency').value),
                url: "",
                logo: ""
            };

            const res = await fetch(API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const errorText = await res.text();
                alert('Error adding subscription: ' + errorText);
                return;
            }

            closeModal();
            fetchSubs();
        }

        // 删除相关变量和逻辑
        // Delete related variables and logic
        let deleteTargetId = null;
        let deleteTargetName = '';

        function openDeleteModal(id) {
            const sub = currentSubs.find(s => s.id === id);
            if(!sub) return;

            deleteTargetId = id;
            deleteTargetName = sub.name;

            document.getElementById('delete-match-name').innerText = sub.name;
            const input = document.getElementById('delete-confirm-input');
            input.value = '';
            
            const btn = document.getElementById('btn-confirm-delete');
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';

            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            deleteTargetId = null;
            deleteTargetName = '';
        }

        // 监听输入以匹配名称
        // Listen to input to match name
        document.getElementById('delete-confirm-input').addEventListener('input', function(e) {
            const val = e.target.value;
            const btn = document.getElementById('btn-confirm-delete');
            if(val === deleteTargetName) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            }
        });

        // 执行删除
        // Execute delete
        async function executeDelete() {
            if(!deleteTargetId) return;
            await fetch(`${API}/${deleteTargetId}`, { method: 'DELETE' });
            closeDeleteModal();
            fetchSubs();
        }

        // 模态框控制函数
        // Modal control functions
        function openModal() { 
            clearError();
            document.getElementById('name').value = '';
            document.getElementById('price').value = '';
            // Reset other fields if needed
            document.getElementById('addModal').style.display = 'block'; 
        }
        function closeModal() { document.getElementById('addModal').style.display = 'none'; }
        
        // 清除错误提示
        // Clear error message
        function clearError() {
            const nameInput = document.getElementById('name');
            const errorMsg = document.getElementById('name-error');
            nameInput.classList.remove('input-error');
            errorMsg.style.display = 'none';
        }

        // 页面加载时获取数据
        // Fetch data on page load
        fetchSubs();
    </script>
</body>
</html>
