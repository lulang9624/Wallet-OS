<!DOCTYPE html>
<!--
  Wallet OS Frontend
  æ¦‚è§ˆï¼š
  - é¡¶éƒ¨ç»Ÿè®¡é¢æ¿ï¼šå±•ç¤ºæœˆåº¦æ€»é¢ä¸æ´»è·ƒ/è¿‡æœŸæ•°é‡
  - è®¢é˜…åˆ—è¡¨ï¼šä»åç«¯ `/api/subscriptions` è·å–ï¼ŒæŒ‰ä¸‹æ¬¡ä»˜æ¬¾æ—¶é—´æ’åº
  - æ¨¡æ€æ¡†ï¼šæ–°å¢/ç¼–è¾‘/ç»­è®¢/åˆ é™¤ç¡®è®¤
  - å›¾æ ‡è·å–ï¼šåç«¯ `/api/icon?domain=...&sz=64`ï¼Œæœ¬åœ°ç¼“å­˜ + HTTP ç¼“å­˜
  - åœ¨çº¿æœç´¢ï¼šè°ƒç”¨ `/api/search?q=...` è·å–å®˜ç½‘åŸŸåå¹¶ç”Ÿæˆ Logo
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet OS</title>
    <!-- å¼•å…¥å¤–éƒ¨æ ·å¼è¡¨ (Import external stylesheet) -->
    <link rel="stylesheet" href="style.css?v=2">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" id="fp-theme" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
</head>
<body>
    <div class="container">
        <div class="top-panel">
            <h1>Wallet OS</h1>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <h3>Total Subscriptions</h3>
                    <div class="value" id="total-count">...</div>
                </div>
                <div class="stat-box">
                    <h3>Active / Expired</h3>
                    <div class="value" id="active-count">...</div>
                </div>
                <div class="stat-box">
                    <h3>Lifetime Subscriptions</h3>
                    <div class="value" id="lifetime-count">...</div>
                </div>
                <div class="stat-box">
                    <h3>Expiring Soon (7d)</h3>
                    <div class="value" id="upcoming-expirations">...</div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="btn" id="theme-toggle" onclick="toggleTheme()">Light Mode</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" style="background: var(--accent);" onclick="openAnalyzeModal()">ğŸ“Š AI Report</button>
                    <button class="btn" onclick="openModal()">+ Add Subscription</button>
                </div>
            </div>
        </div>

        <div id="subs-list">Loading...</div>
    </div>

    <!-- æ·»åŠ è®¢é˜…æ¨¡æ€æ¡† (Add Subscription Modal) -->
    <!-- é»˜è®¤éšè—ï¼Œç‚¹å‡» "+ Add Subscription" æŒ‰é’®åæ˜¾ç¤º -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2>New Subscription</h2>
            
            <!-- æ™ºèƒ½å¯¼å…¥åŒºåŸŸ -->
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px dashed var(--accent);">
                <label style="color: var(--accent); font-weight: bold; display: block; margin-bottom: 8px; font-size: 0.9rem;">âœ¨ Smart Import (AI)</label>
                <div style="display: flex; gap: 10px;">
                    <textarea id="smart-text" placeholder="Paste details here: e.g. 'Netflix $15.99 monthly starting today'" 
                        style="flex: 1; height: 50px; resize: none; font-size: 0.9rem; margin-bottom: 0; padding: 8px; background: rgba(0,0,0,0.2); color: var(--text); border: 1px solid var(--border); border-radius: 4px;"></textarea>
                    <button class="btn" onclick="smartParse()" style="height: 50px; background: var(--accent); white-space: nowrap; padding: 0 15px; display: flex; align-items: center;">
                        Auto Fill
                    </button>
                </div>
            </div>

            <!-- è®¢é˜…è¡¨å• -->
            <!-- Subscription Form -->
            <input type="text" id="name" placeholder="Name (e.g. Netflix)" oninput="clearError()" onfocus="this.select()">
            <!-- é”™è¯¯æç¤ºä¿¡æ¯ -->
            <div id="name-error" class="error-msg">Name is required</div>
            
            <input type="number" id="price" placeholder="Price" oninput="clearError()" onfocus="this.select()">
            <div id="price-error" class="error-msg">Price is required</div>

            <input type="text" id="currency" value="CNY" placeholder="Currency" onfocus="this.select()">
            
            <div style="display: flex; align-items: center; margin-bottom: 10px; justify-content: flex-end;">
                <div style="display: flex; align-items: center;">
                    <input type="checkbox" id="lifetime" onchange="toggleLifetime()" style="width: auto; margin-right: 5px;">
                    <label for="lifetime" style="cursor: pointer;">Lifetime</label>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 5px;">Start Date</label>
                    <input type="date" id="start_date" style="margin: 0;" oninput="clearError()">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 5px;">End Date</label>
                    <input type="date" id="next_payment" oninput="clearError()" style="margin: 0;">
                </div>
            </div>
            <div id="start-date-error" class="error-msg">Start date is required</div>
            <div id="date-error" class="error-msg">End date is required</div>
            
            <button id="btn-save" class="btn" onclick="addSubscription()">Save</button>
            <button class="btn" style="background: #666;" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† (Delete Confirmation Modal) -->
    <!-- é˜²æ­¢è¯¯åˆ æ“ä½œï¼Œè¦æ±‚ç”¨æˆ·è¾“å…¥è®¢é˜…åç§°è¿›è¡Œç¡®è®¤ -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2>Delete Subscription</h2>
            <p>To confirm deletion, type <strong id="delete-match-name" style="color: var(--accent);"></strong> below:</p>
            <input type="text" id="delete-confirm-input" placeholder="Type subscription name">
            
            <div style="text-align: right; margin-top: 15px;">
                <!-- ç¡®è®¤åˆ é™¤æŒ‰é’®ï¼Œé»˜è®¤ç¦ç”¨ -->
                <button id="btn-confirm-delete" class="btn" style="background: #f44336; opacity: 0.5; cursor: not-allowed;" disabled onclick="executeDelete()">Delete</button>
                <button class="btn" style="background: #666;" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- AI åˆ†ææ¨¡æ€æ¡† -->
    <div id="analyzeModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>ğŸ’° Financial Copilot</h2>
            <div id="analyze-loading" style="display: none; text-align: center; padding: 20px;">
                <p>Analyzing your spending patterns...</p>
                <div class="spinner" style="margin: 10px auto; width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--accent); animation: spin 1s ease-in-out infinite;"></div>
            </div>
            <div id="analyze-result" style="white-space: pre-wrap; line-height: 1.6; font-size: 0.95rem; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                Click "Start Analysis" to generate a report.
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button id="btn-start-analyze" class="btn" onclick="startAnalysis()">Start Analysis</button>
                <button class="btn" style="background: #666;" onclick="closeAnalyzeModal()">Close</button>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Markdown æ¸²æŸ“æ ·å¼ä¼˜åŒ– */
        .markdown-body {
            color: var(--text-color);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            color: var(--accent);
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 0.3em;
        }
        .markdown-body p { margin-bottom: 1em; }
        .markdown-body ul, .markdown-body ol { padding-left: 20px; margin-bottom: 1em; }
        .markdown-body li { margin-bottom: 0.3em; }
        .markdown-body code {
            background: var(--md-code-bg);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
            color: var(--text-color);
        }
        .markdown-body pre {
            background: var(--md-pre-bg);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            background: var(--md-table-bg);
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid var(--md-border);
            padding: 8px 12px;
            text-align: left;
        }
        .markdown-body th { background: var(--md-table-bg); color: var(--accent); }
        .markdown-body strong { color: var(--text-color); font-weight: 600; }
    </style>

    <!-- JavaScript é€»è¾‘éƒ¨åˆ† -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // API åŸºç¡€è·¯å¾„
        const API = '/api/subscriptions';
        
        // å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨å½“å‰è·å–åˆ°çš„è®¢é˜…åˆ—è¡¨ï¼Œæ–¹ä¾¿åç»­æŸ¥æ‰¾ï¼ˆå¦‚åˆ é™¤ç¡®è®¤æ—¶æ¯”å¯¹åç§°ï¼‰
        // Global variable to store current subscriptions for easy lookup
        let currentSubs = []; 
        
        // æœç´¢ç»“æœç¼“å­˜ (å­˜å‚¨ Promise ä»¥é¿å…å¹¶å‘è¯·æ±‚)
        // Search result cache (stores Promise to avoid concurrent requests)
        let searchCache = {};
        
        function applyTheme(theme) {
            const root = document.documentElement;
            const fpThemeLink = document.getElementById('fp-theme');
            
            if (theme === 'light') {
                root.setAttribute('data-theme', 'light');
                if (fpThemeLink) fpThemeLink.disabled = true; // Disable dark theme for Flatpickr
            } else {
                root.removeAttribute('data-theme');
                if (fpThemeLink) fpThemeLink.disabled = false; // Enable dark theme for Flatpickr
            }
            const btn = document.getElementById('theme-toggle');
            if (btn) {
                btn.innerText = theme === 'light' ? 'Dark Mode' : 'Light Mode';
            }
        }
        
        function initTheme() {
            let theme = localStorage.getItem('theme');
            if (!theme) {
                theme = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
            }
            applyTheme(theme);
        }
        
        function toggleTheme() {
            document.documentElement.classList.add('theme-transition');
            const current = document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
            const next = current === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', next);
            applyTheme(next);
            setTimeout(() => {
                document.documentElement.classList.remove('theme-transition');
            }, 300);
        }

        /**
         * è·å–å¹¶æ¸²æŸ“è®¢é˜…åˆ—è¡¨
         * Fetch and render subscription list
         */
        async function fetchSubs() {
            try {
                if (window.subsAbortController) {
                    window.subsAbortController.abort();
                }
                window.subsAbortController = new AbortController();
                const res = await fetch(`${API}?t=${new Date().getTime()}`, { signal: window.subsAbortController.signal });
                const data = await res.json();
                
                // æ›´æ–°å…¨å±€æ•°æ®
                currentSubs = data; 
                
                // è®¡ç®—å¹¶æ¸²æŸ“ç»Ÿè®¡æ•°æ®
                renderStats(data);
                
                const list = document.getElementById('subs-list');
                
                // è®°å½•å½“å‰æ»šåŠ¨ä½ç½®ï¼Œé˜²æ­¢åˆ·æ–°æ—¶è·³åŠ¨
                // Save current scroll position to prevent jumping on refresh
                const scrollTop = list.scrollTop;
                
                list.innerHTML = ''; // æ¸…ç©ºç°æœ‰åˆ—è¡¨
                
                // éå†å¹¶ç”Ÿæˆ HTML
                data.forEach(sub => {
                    // Calculate battery status HTML
                    const batteryHtml = getBatteryHtml(sub.next_payment, sub.frequency);
    
                    // Get Logo URL
                    const logoUrl = getLogoUrl(sub);

                    // Calculate Duration / Cycle Label
                    let durationLabel = '';
                    let remainingLabel = '';

                    if (sub.frequency === 0) {
                        durationLabel = 'Lifetime';
                        remainingLabel = '';
                    } else {
                        // Calculate Total Duration
                        if (sub.start_date && sub.next_payment) {
                            const start = new Date(sub.start_date);
                            const end = new Date(sub.next_payment);
                            if (!isNaN(start) && !isNaN(end) && end >= start) {
                                const dayMs = 1000 * 60 * 60 * 24;
                                const rawDays = Math.ceil(Math.abs(end - start) / dayMs);
                                const diffDays = Math.max(1, rawDays + 1); // ç«¯ç‚¹åŒ…å«ï¼ˆå«èµ·æ­¢ä¸¤å¤©ï¼‰
                                if (diffDays >= 360) {
                                    const years = Math.round(diffDays / 365);
                                    durationLabel = years === 1 ? "1 Year" : `${years} Years`;
                                } else if (diffDays >= 30) {
                                    const months = Math.round(diffDays / 30);
                                    durationLabel = months === 1 ? "1 Month" : `${months} Months`;
                                } else {
                                    const d = diffDays <= 0 ? 1 : diffDays;
                                    durationLabel = d === 1 ? "1 Day" : `${d} Days`;
                                }
                            }
                        }
                        // Fallback if no dates or calc failed
                        if (!durationLabel) {
                            if (sub.frequency === 12) durationLabel = "1 Year";
                            else if (sub.frequency === 3) durationLabel = "3 Months";
                            else if (sub.frequency === 1) durationLabel = "1 Month";
                            else if (sub.frequency === -1) durationLabel = "1 Day";
                            else durationLabel = "1 Month";
                        }

                        // Calculate Remaining Days
                        if (sub.next_payment) {
                            const end = new Date(sub.next_payment);
                            const now = new Date();
                            end.setHours(0,0,0,0);
                            now.setHours(0,0,0,0);
                            const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
                            if (diff < 0) remainingLabel = "Expired";
                            else if (diff === 0) remainingLabel = "Today";
                            else remainingLabel = `${diff} Days`;
                        }
                    }

                    // æ‹¼æ¥å¡ç‰‡ HTML
                    list.innerHTML += `
                        <div class="sub-card">
                            <div class="sub-info">
                                <div style="display:flex;align-items:center;">
                                    <img src="${logoUrl}" class="sub-logo" 
                                         onerror="
                                            if(!this.dataset.triedDd) {
                                                this.dataset.triedDd = true;
                                                let domain = '${logoUrl}'.match(/domain=([^&]+)/)[1];
                                                this.src = 'https://icons.duckduckgo.com/ip3/' + domain + '.ico';
                                            } 
                                            else {
                                                this.onerror=null;
                                                this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(sub.name)}&background=random&color=fff&size=64&rounded=true';
                                            }
                                         " />
                                    <h3>${sub.name}</h3>
                                    ${batteryHtml}
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; line-height: 1.4;">
                                    ${sub.frequency === 0 ? 
                                        '<div>Lifetime Access</div>' : 
                                        `
                                        <div>
                                            ${sub.start_date ? `<span>Start: ${sub.start_date}</span> <span style="margin:0 4px;opacity:0.3">|</span>` : ''}
                                            <span>End: ${sub.next_payment || 'N/A'}</span>
                                            <span style="margin:0 4px;opacity:0.3">|</span>
                                            <span style="color: var(--text-color); font-weight: 500;">Total: ${durationLabel}</span>
                                            ${remainingLabel ? `<span style="margin:0 4px;opacity:0.3">|</span> <span style="color: var(--text-color); font-weight: 500;">Left: ${remainingLabel}</span>` : ''}
                                        </div>
                                        `
                                    }
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="sub-price">${sub.currency} ${sub.price}</div>
                                ${sub.frequency !== 0 ? `<button style="background:none; border:none; color:var(--accent); cursor:pointer; margin-right:10px;" onclick="openRenewModal(${sub.id})">Renew</button>` : ''}
                                <button style="background:none; border:none; color:var(--text-muted); cursor:pointer; margin-right:10px;" onclick="openModal(${sub.id})">Edit</button>
                                <button style="background:none; border:none; color:#f44336; cursor:pointer;" onclick="openDeleteModal(${sub.id})">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                // è§¦å‘ç”µæ± æ¡åŠ¨ç”» (å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿ DOM å·²æ¸²æŸ“)
                // Trigger battery animation
                setTimeout(() => {
                    document.querySelectorAll('.battery-level').forEach(el => {
                        el.style.width = el.getAttribute('data-width');
                    });
                }, 100);

                // æ¢å¤æ»šåŠ¨ä½ç½®
                // Restore scroll position
                if (scrollTop > 0) {
                    list.scrollTop = scrollTop;
                }
            } catch (error) {
                if (error && error.name === 'AbortError') return;
                console.error("Failed to fetch subscriptions:", error);
                document.getElementById('subs-list').innerText = "Failed to load data.";
            }
        }

        /**
         * ç”Ÿæˆç”µæ± å›¾æ ‡ HTML
         * Generate Battery Icon HTML
         * 
         * æ ¹æ®å‰©ä½™å¤©æ•°å’Œå‘¨æœŸè®¡ç®—ç”µé‡ç™¾åˆ†æ¯”å’Œé¢œè‰²ã€‚
         * Calculates percentage and color based on days left and cycle.
         * 
         * @param {string} nextDateStr - ä¸‹æ¬¡ä»˜æ¬¾æ—¥æœŸå­—ç¬¦ä¸²
         * @param {number} frequency - ä»˜æ¬¾é¢‘ç‡ (1=æœˆ, 12=å¹´)
         */
        function getBatteryHtml(nextDateStr, frequency) {
            // æ°¸ä¹…è®¢é˜…å¤„ç†
            // Handle lifetime subscription
            if (frequency === 0) {
                return `
                    <div class="battery-container" title="Lifetime">
                        <div class="battery" style="border-color: gold;">
                            <div class="battery-level" style="width: 100%; background: gold;" data-width="100%"></div>
                        </div>
                        <span class="days-left" style="color: gold;">âˆ</span>
                    </div>
                `;
            }

            if (!nextDateStr) return '';
            
            const nextDate = new Date(nextDateStr);
            const now = new Date();
            
            // é‡ç½®æ—¶é—´éƒ¨åˆ†ï¼Œåªæ¯”è¾ƒæ—¥æœŸï¼Œé¿å…å› æ—¶åˆ†ç§’å¯¼è‡´çš„è®¡ç®—åå·®
            // Reset time part, only compare dates
            nextDate.setHours(0,0,0,0);
            now.setHours(0,0,0,0);

            let diffTime = nextDate - now;
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // å¤„ç†å·²è¿‡æœŸçš„æƒ…å†µ
            // Handle overdue cases
            if (diffDays < 0) {
                return `
                    <div class="battery-container" title="Expired">
                        <div class="battery" style="border-color: #666;">
                            <div class="battery-level" style="width: 0%; background: #666;" data-width="0%"></div>
                        </div>
                        <span class="days-left" style="color:#666">Expired</span>
                    </div>
                `;
            }
            if (diffDays === 0) diffDays = 1;

            // ä¼°ç®—å‘¨æœŸé•¿åº¦ï¼ˆå¤©ï¼‰ç”¨äºè®¡ç®—ç™¾åˆ†æ¯”
            // Estimate cycle length (days) for percentage calculation
            const cycleDays = frequency === 12 ? 365 : (frequency === 3 ? 90 : (frequency === -1 ? 1 : 30));
            
            // è®¡ç®—ç™¾åˆ†æ¯” (å‰©ä½™å¤©æ•° / å‘¨æœŸ)
            // Calculate percentage (days left / cycle)
            let percentage = (diffDays / cycleDays) * 100;
            if (percentage > 100) percentage = 100; // é˜²æ­¢æ–°ç»­è´¹æ—¶æº¢å‡º
            
            // æ ¹æ®å‰©ä½™ç”µé‡ç¡®å®šé¢œè‰² (ç»¿ -> æ©™ -> çº¢)
            // Determine color based on level
            let color = '#4caf50'; // Green
            if (percentage < 20) {
                color = '#f44336'; // Red
            } else if (percentage < 50) {
                color = '#ff9800'; // Orange
            }

            return `
                <div class="battery-container" title="${diffDays} days left">
                    <div class="battery">
                        <!-- data-width ç”¨äº JS åŠ¨ç”» -->
                        <div class="battery-level" style="background: ${color}; width: 0%" data-width="${percentage}%"></div>
                    </div>
                    <span class="days-left">${diffDays}d</span>
                </div>
            `;
        }

        /**
         * è·å–è®¢é˜…å›¾æ ‡ URL
         * Get Subscription Logo URL
         * 
         * é€»è¾‘ï¼š
         * 1. å¦‚æœæ•°æ®åº“ä¸­æœ‰ logo å­—æ®µï¼Œç›´æ¥ä½¿ç”¨
         * 2. å¦‚æœæœ‰ url å­—æ®µï¼Œæå–åŸŸåå¹¶è°ƒç”¨ Clearbit API
         * 3. å¦‚æœåªæœ‰ nameï¼Œå°è¯•çŒœæµ‹åŸŸå (name + .com) å¹¶è°ƒç”¨ Clearbit API
         * 
         * Logic:
         * 1. Use DB logo if available.
         * 2. If url exists, extract domain and use Clearbit API.
         * 3. If only name, guess domain (name.com) and use Clearbit API.
         */
        function getLogoUrl(sub) {
            // 1. ä¼˜å…ˆä½¿ç”¨å·²ä¿å­˜çš„ Logo
            if (sub.logo && sub.logo.trim() !== '') {
                const saved = sub.logo.trim();
                const m = saved.match(/domain=([^&]+)/);
                if (m) {
                    const d = m[1];
                    const szm = saved.match(/sz=(\d+)/);
                    const size = szm ? szm[1] : '64';
                    return `/api/icon?domain=${d}&sz=${size}`;
                }
                return saved;
            }

            let domain = '';

            // 2. å°è¯•ä» URL æå–åŸŸå
            if (sub.url && sub.url.trim() !== '') {
                try {
                    // å¤„ç†æ²¡æœ‰ http å‰ç¼€çš„æƒ…å†µ
                    let urlStr = sub.url;
                    if (!urlStr.startsWith('http')) {
                        urlStr = 'https://' + urlStr;
                    }
                    const urlObj = new URL(urlStr);
                    domain = urlObj.hostname;
                    
                    // ä¿®æ­£ï¼šå¦‚æœåŸŸåä¸åŒ…å«ç‚¹ï¼ˆä¾‹å¦‚ç”¨æˆ·åªè¾“å…¥äº† "icloud"ï¼‰ï¼Œè‡ªåŠ¨è¡¥å…¨ .com
                    // Fix: If domain has no dot (e.g. user entered "icloud"), append .com
                    if (domain && !domain.includes('.')) {
                        domain += '.com';
                    }
                } catch (e) {
                    console.warn("Invalid URL:", sub.url);
                }
            }

            // 3. å¦‚æœæ²¡æœ‰ URLï¼Œæ ¹æ®åç§°çŒœæµ‹åŸŸå
            if (!domain) {
                const cleanName = sub.name.toLowerCase().replace(/\s+/g, '');
                // é»˜è®¤çŒœæµ‹ï¼šåç§° + .com
                // Default guess: name + .com
                domain = cleanName + '.com';
            }

            // ä½¿ç”¨ Google Favicon æœåŠ¡ä½œä¸ºé¦–é€‰ (æ›´ç¨³å®š)
            // Use Google Favicon service as primary (more stable)
            return `/api/icon?domain=${domain}&sz=64`;
        }

        /**
         * åœ¨çº¿æœç´¢å…¬å¸ä¿¡æ¯ (è°ƒç”¨åç«¯ API)
         * Online search for company info via Backend API
         *
         * ä½¿ç”¨ Promise ç¼“å­˜æœºåˆ¶ï¼Œç¡®ä¿åŒä¸€ä¸ªåç§°åªå‘èµ·ä¸€æ¬¡è¯·æ±‚
         * Uses Promise caching to ensure only one request per name
         */
        function searchCompany(name) {
            // 1. æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å·²æœ‰ Promise
            if (searchCache[name]) {
                return searchCache[name];
            }

            // 2. åˆ›å»ºæ–°çš„ Promise å¹¶å­˜å…¥ç¼“å­˜
            const promise = (async () => {
                try {
                    const res = await fetch(`/api/search?q=${encodeURIComponent(name)}`);
                    if (res.ok) {
                        const data = await res.json();
                        if (data && data.domain) {
                            return {
                                name: name,
                                domain: data.domain,
                                logo: `/api/icon?domain=${data.domain}&sz=64`
                            };
                        }
                    }
                } catch (e) {
                    console.warn("Company search failed:", e);
                }
                return null;
            })();

            searchCache[name] = promise;
            return promise;
        }

        /**
         * è®¡ç®—å¹¶æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
         * Calculate and display statistics
         */
        function renderStats(subs) {
            const now = new Date();
            now.setHours(0,0,0,0);
            let activeCount = 0;
            let expiredCount = 0;
            let totalCount = subs.length;
            let lifetimeCount = 0;
            let upcomingExpirations = 0;
            const oneWeekFromNow = new Date(now);
            oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7);

            subs.forEach(sub => {
                if (sub.frequency === 0) {
                    activeCount++;
                    lifetimeCount++;
                    return;
                }
                if (!sub.next_payment) {
                    activeCount++;
                    return;
                }
                const nextDate = new Date(sub.next_payment);
                nextDate.setHours(0,0,0,0);
                if (nextDate < now) {
                    expiredCount++;
                } else {
                    activeCount++;
                    if (nextDate <= oneWeekFromNow) {
                        upcomingExpirations++;
                    }
                }
            });
            document.getElementById('active-count').innerHTML = `
                <span style="color: #4caf50" title="Active">${activeCount}</span> / 
                <span style="color: #f44336" title="Expired">${expiredCount}</span>
            `;
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('lifetime-count').textContent = lifetimeCount;
            document.getElementById('upcoming-expirations').textContent = upcomingExpirations;
        }

        /**
         * åˆ‡æ¢æ°¸ä¹…è®¢é˜…çŠ¶æ€
         * Toggle Lifetime Subscription status
         */
        function toggleLifetime() {
            const isLifetime = document.getElementById('lifetime').checked;
            const dateInput = document.getElementById('next_payment');
            const priceInput = document.getElementById('price');
            const fp = dateInput._flatpickr;

            if (isLifetime) {
                if (fp) {
                    fp.clear();
                    fp._input.disabled = true; // Disable alt input
                } else {
                    dateInput.disabled = true;
                    dateInput.value = '';
                }
                dateInput.style.opacity = '0.5';
                
                priceInput.placeholder = "Price (Optional for Lifetime)";
            } else {
                if (fp) {
                    fp._input.disabled = false;
                } else {
                    dateInput.disabled = false;
                }
                dateInput.style.opacity = '1';
                
                priceInput.placeholder = "Price";
            }
            clearError();
        }

        /**
         * æ·»åŠ æ–°è®¢é˜…
         * Add new subscription
         */
        async function addSubscription() {
            const btnSave = document.getElementById('btn-save');
            const nameInput = document.getElementById('name');
            const priceInput = document.getElementById('price');
            const dateInput = document.getElementById('next_payment');
            const startDateInput = document.getElementById('start_date');
            const isLifetime = document.getElementById('lifetime').checked;
            const inferFrequency = (startStr, nextStr) => {
                const s = new Date(startStr);
                const n = new Date(nextStr);
                if (isNaN(s) || isNaN(n)) return 1;
                s.setHours(0,0,0,0);
                n.setHours(0,0,0,0);
                const diffDays = Math.ceil((n - s) / (1000 * 60 * 60 * 24));
                if (diffDays <= 1) return -1;
                if (diffDays >= 330) return 12;
                if (diffDays >= 80 && diffDays <= 100) return 3;
                return 1;
            };
            
            // Clear previous errors
            clearError();
            
            let hasError = false;
            
            // 1. Validate Name
            if (!nameInput.value || nameInput.value.trim() === '') {
                nameInput.classList.add('input-error');
                document.getElementById('name-error').style.display = 'block';
                hasError = true;
            }
            
            // 2. Validate Price (Required unless Lifetime)
            // Note: Lifetime allows empty price (backend defaults to 0)
            if (!isLifetime && (!priceInput.value || priceInput.value.trim() === '')) {
                priceInput.classList.add('input-error');
                document.getElementById('price-error').style.display = 'block';
                hasError = true;
            }

            // 3. Validate Start Date (Required unless Lifetime)
            if (!isLifetime && (!startDateInput.value || startDateInput.value.trim() === '')) {
                startDateInput.classList.add('input-error');
                document.getElementById('start-date-error').style.display = 'block';
                hasError = true;
            }

            // 4. Validate Next Payment Date (Required unless Lifetime)
            if (!isLifetime) {
                const errorMsg = document.getElementById('date-error');
                
                // Check for invalid date (e.g. Feb 31) which results in empty value but badInput=true
                if (dateInput.validity && dateInput.validity.badInput) {
                    dateInput.classList.add('input-error');
                    errorMsg.innerText = "Invalid date";
                    errorMsg.style.display = 'block';
                    hasError = true;
                }
                // Check for empty value
                else if (!dateInput.value || dateInput.value.trim() === '') {
                    dateInput.classList.add('input-error');
                    errorMsg.innerText = "End date is required";
                    errorMsg.style.display = 'block';
                    hasError = true;
                }
                // Cross-field check: Next >= Start
                else if (startDateInput.value && dateInput.value) {
                    const s = new Date(startDateInput.value);
                    const n = new Date(dateInput.value);
                    s.setHours(0,0,0,0);
                    n.setHours(0,0,0,0);
                    if (n < s) {
                        dateInput.classList.add('input-error');
                        errorMsg.innerText = "End date must be after start date";
                        errorMsg.style.display = 'block';
                        hasError = true;
                    }
                }
            }
            
            if (hasError) return;

            const originalBtnText = btnSave.innerText;
            btnSave.disabled = true;
            btnSave.innerText = "Processing...";
            btnSave.style.opacity = "0.7";
            btnSave.style.cursor = "not-allowed";

            try {
                const payload = {
                    name: nameInput.value,
                    price: priceInput.value ? parseFloat(priceInput.value) : null, // Send null if empty
                    currency: document.getElementById('currency').value,
                    next_payment: isLifetime ? null : dateInput.value,
                    frequency: isLifetime ? 0 : inferFrequency(startDateInput.value, dateInput.value),
                    url: "", // Removed input, handled by auto-search logic below
                    logo: "",
                    start_date: document.getElementById('start_date').value || null
                };

                // å°è¯•è‡ªåŠ¨åŒ¹é… URL (ä»…åœ¨ Name å˜æ›´æˆ– Logo ä¸ºç©ºæ—¶è§¦å‘)
                // Try auto-match URL (only if name changed or logo empty)
                if (!isEditMode || !originalLogo) {
                    btnSave.innerText = "Searching Domain...";
                    const companyInfo = await searchCompany(payload.name);

                    if (companyInfo && companyInfo.domain) {
                        payload.url = 'https://' + companyInfo.domain;
                        payload.logo = companyInfo.logo;
                        console.log(`Auto-matched: ${companyInfo.domain}`);
                    }
                } else {
                    // ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œå¦‚æœæ²¡é‡æ–°æœç´¢ï¼Œä¿æŒåŸæœ‰ Logo
                    // In edit mode, keep original logo if not re-searched
                    payload.logo = originalLogo;
                }

                btnSave.innerText = isEditMode ? "Updating..." : "Saving...";
                
                const url = isEditMode ? `${API}/${editId}` : API;
                const method = isEditMode ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    alert(`Error ${isEditMode ? 'updating' : 'adding'} subscription: ` + errorText);
                    return;
                }

                closeModal();
                fetchSubs(); 
            } catch (error) {
                console.error("Error:", error);
                alert("An unexpected error occurred.");
            } finally {
                btnSave.disabled = false;
                btnSave.innerText = originalBtnText; // Restore original text (Save/Update)
                btnSave.style.opacity = "1";
                btnSave.style.cursor = "pointer";
            }
        }

        // ==============================
        // åˆ é™¤åŠŸèƒ½ç›¸å…³çš„é€»è¾‘ (Delete Logic)
        // ==============================
        let deleteTargetId = null;
        let deleteTargetName = '';

        /**
         * æ‰“å¼€åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
         * Open delete confirmation modal
         */
        function openDeleteModal(id) {
            // åœ¨å…¨å±€æ•°æ®ä¸­æŸ¥æ‰¾è¯¥è®¢é˜…
            const sub = currentSubs.find(s => s.id === id);
            if(!sub) return;

            deleteTargetId = id;
            deleteTargetName = sub.name;

            // æ›´æ–° UI
            document.getElementById('delete-match-name').innerText = sub.name;
            const input = document.getElementById('delete-confirm-input');
            input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            
            // é‡ç½®åˆ é™¤æŒ‰é’®çŠ¶æ€ï¼ˆç¦ç”¨ï¼‰
            const btn = document.getElementById('btn-confirm-delete');
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';

            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            deleteTargetId = null;
            deleteTargetName = '';
        }

        // ç›‘å¬è¾“å…¥æ¡†ï¼ŒåŒ¹é…è®¢é˜…åç§°
        // Listen to input to match subscription name
        document.getElementById('delete-confirm-input').addEventListener('input', function(e) {
            const val = e.target.value;
            const btn = document.getElementById('btn-confirm-delete');
            
            // åªæœ‰è¾“å…¥å†…å®¹å®Œå…¨åŒ¹é…è®¢é˜…åç§°æ—¶ï¼Œæ‰å¯ç”¨åˆ é™¤æŒ‰é’®
            // Enable delete button only if input matches name exactly
            if(val === deleteTargetName) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            }
        });

        /**
         * æ‰§è¡ŒçœŸæ­£çš„åˆ é™¤æ“ä½œ
         * Execute actual delete operation
         */
        async function executeDelete() {
            if(!deleteTargetId) return;
            await fetch(`${API}/${deleteTargetId}`, { method: 'DELETE' });
            closeDeleteModal();
            fetchSubs(); // åˆ·æ–°åˆ—è¡¨
        }

        // ç¼–è¾‘æ¨¡å¼çŠ¶æ€
        // Edit mode state
        let isEditMode = false;
        let editId = null;
        let originalLogo = "";

        /**
         * æ‰“å¼€ç»­è®¢æ¨¡æ€æ¡†
         * Open Renew Modal
         * 
         * å¤ç”¨ç¼–è¾‘æ¨¡æ€æ¡†ï¼Œä½†é¢„å¡«å……è®¡ç®—åçš„æ—¥æœŸï¼Œå…è®¸ç”¨æˆ·ä¿®æ”¹ä»·æ ¼æˆ–æ—¥æœŸ
         * Reuses edit modal, but pre-fills calculated date, allowing user to modify price or date
         */
        function openRenewModal(id) {
            const sub = currentSubs.find(s => s.id === id);
            if (!sub || sub.frequency === 0 || !sub.next_payment) {
                alert("Cannot renew this subscription.");
                return;
            }

            // è®¡ç®—æ¨èçš„ä¸‹æ¬¡ä»˜æ¬¾æ—¥æœŸ
            // Calculate recommended next payment date
            const currentNext = new Date(sub.next_payment);
            let nextDate = new Date(currentNext);
            
            // è¾…åŠ©å‡½æ•°ï¼šæ™ºèƒ½å¢åŠ æœˆä»½ï¼ˆå¤„ç†æœˆæœ«é€»è¾‘ï¼‰
            // Helper: Smart add months (handle end-of-month logic)
            const addMonths = (date, months) => {
                const d = date.getDate();
                date.setMonth(date.getMonth() + months);
                // å¦‚æœæ—¥æœŸå‘ç”Ÿå˜åŒ–ï¼ˆä¾‹å¦‚ 1.31 -> 3.3ï¼‰ï¼Œè¯´æ˜ç›®æ ‡æœˆä»½æ²¡æœ‰é‚£ä¸€å¤©ï¼Œå›é€€åˆ°æœˆæœ«
                // If date changes (e.g. 1.31 -> 3.3), it means target month lacks that day, snap to end of month
                if (date.getDate() !== d) {
                    date.setDate(0);
                }
            };

            // å¢åŠ ä¸€ä¸ªå‘¨æœŸ
            if (sub.frequency === 12) {
                // å¹´ä»˜ä¹Ÿéœ€è¦å¤„ç†é—°å¹´é€»è¾‘ (2.29 -> 2.28)
                const d = nextDate.getDate();
                nextDate.setFullYear(nextDate.getFullYear() + 1);
                if (nextDate.getDate() !== d) {
                    nextDate.setDate(0);
                }
            } else if (sub.frequency === -1) { // Daily
                 nextDate.setDate(nextDate.getDate() + 1);
            } else { // Monthly
                addMonths(nextDate, 1);
            }
            
            const nextDateStr = nextDate.toISOString().split('T')[0];

            // å¤ç”¨ openModal é€»è¾‘ï¼Œä½†åœ¨ UI ä¸ŠåšåŒºåˆ†
            // Reuse openModal logic, but distinguish in UI
            openModal(id);
            
            // è¦†ç›– openModal è®¾ç½®çš„éƒ¨åˆ† UI
            // Override some UI set by openModal
            const modalTitle = document.querySelector('#addModal h2');
            const btnSave = document.getElementById('btn-save');
            
            modalTitle.innerText = "Renew Subscription";
            btnSave.innerText = "Confirm Renewal";
            
            // é¢„å¡«å……è®¡ç®—åçš„æ—¥æœŸ
            // Pre-fill calculated date
            const nextFp = document.getElementById('next_payment')._flatpickr;
            if (nextFp) nextFp.setDate(nextDateStr);
            else document.getElementById('next_payment').value = nextDateStr;
        }

        // ==============================
        // é€šç”¨æ¨¡æ€æ¡†æ§åˆ¶ (Modal Controls)
        // ==============================
        /**
         * æ‰“å¼€æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡†
         * Open Add/Edit Modal
         * @param {number|null} id - å¦‚æœæä¾› IDï¼Œåˆ™è¿›å…¥ç¼–è¾‘æ¨¡å¼ (If ID provided, enter edit mode)
         */
        function openModal(id = null) { 
            clearError();
            const modalTitle = document.querySelector('#addModal h2');
            const btnSave = document.getElementById('btn-save');
            
            const startFp = document.getElementById('start_date')._flatpickr;
            const nextFp = document.getElementById('next_payment')._flatpickr;

            if (id) {
                // ç¼–è¾‘æ¨¡å¼
                // Edit Mode
                const sub = currentSubs.find(s => s.id === id);
                if (!sub) return;

                isEditMode = true;
                editId = id;
                originalLogo = sub.logo; // ä¿å­˜åŸæœ‰ Logoï¼Œé¿å…ç¼–è¾‘æ—¶ä¸¢å¤±
                
                modalTitle.innerText = "Edit Subscription";
                btnSave.innerText = "Update";

                // å¡«å……è¡¨å•
                document.getElementById('name').value = sub.name;
                document.getElementById('price').value = sub.price;
                document.getElementById('currency').value = sub.currency;
                
                if (startFp) startFp.setDate(sub.start_date || '');
                else document.getElementById('start_date').value = sub.start_date || '';
                
                // å¤„ç† Lifetime
                if (sub.frequency === 0) {
                    document.getElementById('lifetime').checked = true;
                    if (nextFp) nextFp.clear();
                    else document.getElementById('next_payment').value = '';
                } else {
                    document.getElementById('lifetime').checked = false;
                    if (nextFp) nextFp.setDate(sub.next_payment || '');
                    else document.getElementById('next_payment').value = sub.next_payment || '';
                }
                
                toggleLifetime(); // æ›´æ–° UI çŠ¶æ€
            } else {
                // æ–°å¢æ¨¡å¼
                // Add Mode
                isEditMode = false;
                editId = null;
                originalLogo = "";
                
                modalTitle.innerText = "New Subscription";
                btnSave.innerText = "Save";

                // é‡ç½®è¡¨å•
                document.getElementById('name').value = '';
                document.getElementById('price').value = '';
                document.getElementById('currency').value = 'CNY';
                document.getElementById('lifetime').checked = false;
                // æ¸…ç©ºæ™ºèƒ½å¯¼å…¥æ–‡æœ¬ï¼Œé¿å…æ®‹ç•™å½±å“æ–°å¢
                const smartText = document.getElementById('smart-text');
                if (smartText) smartText.value = '';
                
                if (nextFp) nextFp.clear();
                else document.getElementById('next_payment').value = '';
                
                if (startFp) startFp.clear();
                else document.getElementById('start_date').value = '';
                
                toggleLifetime(); 
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('addModal').style.display = 'block'; 
        }
        
        function closeModal() { 
            document.getElementById('addModal').style.display = 'none'; 
            // å…³é—­æ—¶ä¹Ÿæ¸…ç©ºæ™ºèƒ½å¯¼å…¥æ–‡æœ¬ï¼Œä¿æŒä¸‹ä¸€æ¬¡æ–°å¢æ¸…çˆ½
            const smartText = document.getElementById('smart-text');
            if (smartText) smartText.value = '';
        }
        
        // æ¸…é™¤è¡¨å•é”™è¯¯æ ·å¼
        // Clear form error styles
        function clearError() {
            // Name
            document.getElementById('name').classList.remove('input-error');
            document.getElementById('name-error').style.display = 'none';
            
            // Price
            document.getElementById('price').classList.remove('input-error');
            document.getElementById('price-error').style.display = 'none';
            
            // Start Date
            document.getElementById('start_date').classList.remove('input-error');
            document.getElementById('start-date-error').style.display = 'none';

            // Next Date
            document.getElementById('next_payment').classList.remove('input-error');
            document.getElementById('date-error').style.display = 'none';
        }

        // é¡µé¢åŠ è½½å®Œæˆåç«‹å³è·å–æ•°æ®
        // Fetch data immediately on page load
        initTheme();
        
        // Initialize Flatpickr
        const fpConfig = {
            altInput: true,
            altFormat: "Y-m-d",
            dateFormat: "Y-m-d",
            allowInput: true,
            static: true
        };
        flatpickr("#start_date", fpConfig);
        flatpickr("#next_payment", fpConfig);
        
        fetchSubs();
        let es;
        function setupRealtime() {
            es = new EventSource('/api/stream');
            es.onmessage = () => { fetchSubs(); };
            es.onerror = () => {
                es.close();
                setTimeout(setupRealtime, 1500);
            };
        }
        setupRealtime();

        // è‡ªåŠ¨åˆ·æ–°æœºåˆ¶ (æ¯ 5 ç§’åˆ·æ–°ä¸€æ¬¡)
        // Auto-refresh mechanism removed as per user request
        // The list will now only update on manual actions or page reload.

        // å½“é¡µé¢é‡æ–°å˜ä¸ºå¯è§æ—¶ç«‹å³åˆ·æ–°
        // Refresh immediately when page becomes visible
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                fetchSubs();
            }
        });
        async function smartParse() {
            const text = document.getElementById('smart-text').value;
            if (!text.trim()) return;

            const btn = document.querySelector('button[onclick="smartParse()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Analyzing...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/smart-parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.name) document.getElementById('name').value = data.name;
                    if (data.price) document.getElementById('price').value = data.price;
                    if (data.currency) document.getElementById('currency').value = data.currency;
                    
                    if (data.start_date) {
                         const fp = document.getElementById('start_date')._flatpickr;
                         if (fp) fp.setDate(data.start_date);
                         else document.getElementById('start_date').value = data.start_date;
                    }
                    // å¦‚æœè§£æç»“æœæŒ‡ç¤ºä¸ºæ°¸ä¹…è®¢é˜…ï¼Œåˆ™å‹¾é€‰å¹¶æ¸…ç©º End
                    if (data.frequency === 0) {
                        document.getElementById('lifetime').checked = true;
                        toggleLifetime();
                    }
                    const endCandidate = data.next_payment || data.end || data.end_date || data.next || data.nextDate || data['End'];
                    const isLifetime = document.getElementById('lifetime').checked;
                    if (!isLifetime && endCandidate) {
                        const fp = document.getElementById('next_payment')._flatpickr;
                        if (fp) fp.setDate(endCandidate);
                        else document.getElementById('next_payment').value = endCandidate;
                    }
                    
                    // Clear errors
                    clearError();
                }
            } catch (e) {
                console.error(e);
                alert('Smart parse failed');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Analysis Modal Logic
        function openAnalyzeModal() {
            document.getElementById('analyzeModal').style.display = 'flex';
            const result = document.getElementById('analyze-result');
            result.innerHTML = 'Click "Start Analysis" to generate a report.';
            result.classList.remove('markdown-body'); // Reset class
            document.getElementById('btn-start-analyze').style.display = 'inline-block';
        }

        function closeAnalyzeModal() {
            document.getElementById('analyzeModal').style.display = 'none';
        }

        async function startAnalysis() {
            const btn = document.getElementById('btn-start-analyze');
            const loading = document.getElementById('analyze-loading');
            const result = document.getElementById('analyze-result');
            
            btn.style.display = 'none';
            loading.style.display = 'block';
            result.innerHTML = '';
            result.classList.add('markdown-body'); // Add markdown styling class

            try {
                const res = await fetch('/api/analyze', { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    result.innerHTML = marked.parse(data.analysis);
                } else {
                    result.innerHTML = "Error: Failed to fetch analysis.";
                }
            } catch (e) {
                console.error(e);
                result.innerHTML = "Error: Network failure.";
            } finally {
                loading.style.display = 'none';
                // Don't show start button again, forcing user to close or re-open to reset
            }
        }
    </script>
</body>
</html>
