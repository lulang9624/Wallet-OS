<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallos Next</title>
    <!-- 引入外部样式表 (Import external stylesheet) -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Wallet OS</h1>
        
        <!-- 统计展示区域 (Statistics Display Area) -->
        <!-- 用于显示总月费和活跃订阅数量 -->
        <div class="stats-grid">
            <div class="stat-box">
                <h3>Total Monthly</h3>
                <div class="value" id="total-cost">...</div>
            </div>
            <div class="stat-box">
                <h3>Active Subs</h3>
                <div class="value" id="active-count">...</div>
            </div>
        </div>

        <!-- 操作按钮区域 (Action Button Area) -->
        <div style="text-align: right; margin-bottom: 20px;">
            <button class="btn" onclick="openModal()">+ Add Subscription</button>
        </div>

        <!-- 订阅列表容器 (Subscription List Container) -->
        <!-- JS 将会动态把订阅卡片插入到这里 -->
        <div id="subs-list">Loading...</div>
    </div>

    <!-- 添加订阅模态框 (Add Subscription Modal) -->
    <!-- 默认隐藏，点击 "+ Add Subscription" 按钮后显示 -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2>New Subscription</h2>
            
            <!-- 订阅表单 -->
            <!-- Subscription Form -->
            <input type="text" id="name" placeholder="Name (e.g. Netflix)" oninput="clearError()" onfocus="this.select()">
            <!-- 错误提示信息 -->
            <div id="name-error" class="error-msg">Name is required</div>
            
            <input type="number" id="price" placeholder="Price" oninput="clearError()" onfocus="this.select()">
            <div id="price-error" class="error-msg">Price is required</div>

            <input type="text" id="currency" value="CNY" placeholder="Currency" onfocus="this.select()">
            
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <select id="frequency" style="flex: 1; margin-bottom: 0;">
                    <option value="1">Monthly</option>
                    <option value="12">Yearly</option>
                </select>
                <div style="margin-left: 15px; display: flex; align-items: center;">
                    <input type="checkbox" id="lifetime" onchange="toggleLifetime()" style="width: auto; margin-right: 5px;">
                    <label for="lifetime" style="cursor: pointer;">Lifetime</label>
                </div>
            </div>

            <input type="date" id="next_payment" oninput="clearError()">
            <div id="date-error" class="error-msg">Next payment date is required</div>
            
            <button id="btn-save" class="btn" onclick="addSubscription()">Save</button>
            <button class="btn" style="background: #666;" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- 删除确认模态框 (Delete Confirmation Modal) -->
    <!-- 防止误删操作，要求用户输入订阅名称进行确认 -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2>Delete Subscription</h2>
            <p>To confirm deletion, type <strong id="delete-match-name" style="color: var(--accent);"></strong> below:</p>
            <input type="text" id="delete-confirm-input" placeholder="Type subscription name">
            
            <div style="text-align: right; margin-top: 15px;">
                <!-- 确认删除按钮，默认禁用 -->
                <button id="btn-confirm-delete" class="btn" style="background: #f44336; opacity: 0.5; cursor: not-allowed;" disabled onclick="executeDelete()">Delete</button>
                <button class="btn" style="background: #666;" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- JavaScript 逻辑部分 -->
    <script>
        // API 基础路径
        const API = '/api/subscriptions';
        
        // 全局变量，用于存储当前获取到的订阅列表，方便后续查找（如删除确认时比对名称）
        // Global variable to store current subscriptions for easy lookup
        let currentSubs = []; 
        
        // 搜索结果缓存 (存储 Promise 以避免并发请求)
        // Search result cache (stores Promise to avoid concurrent requests)
        let searchCache = {};

        /**
         * 获取并渲染订阅列表
         * Fetch and render subscription list
         */
        async function fetchSubs() {
            try {
                // 发送 GET 请求获取数据
                const res = await fetch(API);
                const data = await res.json();
                
                // 更新全局数据
                currentSubs = data; 
                
                // 计算并渲染统计数据
                renderStats(data);
                
                const list = document.getElementById('subs-list');
                list.innerHTML = ''; // 清空现有列表
                
                // 遍历并生成 HTML
                data.forEach(sub => {
                    let freqLabel;
                    if (sub.frequency === 0) {
                        freqLabel = ''; // No label for lifetime
                    } else {
                        freqLabel = sub.frequency === 12 ? '/yr' : '/mo';
                    }
                    
                    // 计算电池状态 HTML
                    // Calculate battery status HTML
                    const batteryHtml = getBatteryHtml(sub.next_payment, sub.frequency);
    
                    // 获取 Logo URL (如果数据库中没有 logo 字段，则自动生成)
                    // Get Logo URL (auto-generate if missing in DB)
                    const logoUrl = getLogoUrl(sub);

                    // 拼接卡片 HTML
                    list.innerHTML += `
                        <div class="sub-card">
                            <div class="sub-info">
                                <div style="display:flex;align-items:center;">
                                    <!-- 显示 Logo，支持三级回退策略：Google -> DuckDuckGo -> UI Avatars -->
                                    <img src="${logoUrl}" class="sub-logo" 
                                         onerror="
                                            // 第一次失败：尝试 DuckDuckGo
                                            if(!this.dataset.triedDd) {
                                                this.dataset.triedDd = true;
                                                let domain = '${logoUrl}'.match(/domain=([^&]+)/)[1];
                                                this.src = 'https://icons.duckduckgo.com/ip3/' + domain + '.ico';
                                            } 
                                            // 第二次失败：使用 UI Avatars 显示首字母
                                            else {
                                                this.onerror=null;
                                                this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(sub.name)}&background=random&color=fff&size=64&rounded=true';
                                            }
                                         " />
                                    <h3>${sub.name}</h3>
                                    ${batteryHtml}
                                </div>
                                <small>${sub.frequency === 0 ? 'Lifetime' : 'Next: ' + (sub.next_payment || 'N/A')}</small>
                            </div>
                            <div style="text-align: right;">
                                <div class="sub-price">${sub.currency} ${sub.price}${freqLabel ? '<span style="font-size:0.8rem;color:#aaa">' + freqLabel + '</span>' : ''}</div>
                                <!-- 编辑按钮 -->
                                <button style="background:none; border:none; color:var(--text-muted); cursor:pointer; margin-right:10px;" onclick="openModal(${sub.id})">Edit</button>
                                <!-- 删除按钮，点击触发 openDeleteModal -->
                                <button style="background:none; border:none; color:#f44336; cursor:pointer;" onclick="openDeleteModal(${sub.id})">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                // 触发电池条动画 (延迟执行以确保 DOM 已渲染)
                // Trigger battery animation
                setTimeout(() => {
                    document.querySelectorAll('.battery-level').forEach(el => {
                        el.style.width = el.getAttribute('data-width');
                    });
                }, 100);
            } catch (error) {
                console.error("Failed to fetch subscriptions:", error);
                document.getElementById('subs-list').innerText = "Failed to load data.";
            }
        }

        /**
         * 生成电池图标 HTML
         * Generate Battery Icon HTML
         * 
         * 根据剩余天数和周期计算电量百分比和颜色。
         * Calculates percentage and color based on days left and cycle.
         * 
         * @param {string} nextDateStr - 下次付款日期字符串
         * @param {number} frequency - 付款频率 (1=月, 12=年)
         */
        function getBatteryHtml(nextDateStr, frequency) {
            // 永久订阅处理
            // Handle lifetime subscription
            if (frequency === 0) {
                return `
                    <div class="battery-container" title="Lifetime">
                        <div class="battery" style="border-color: gold;">
                            <div class="battery-level" style="width: 100%; background: gold;" data-width="100%"></div>
                        </div>
                        <span class="days-left" style="color: gold;">∞</span>
                    </div>
                `;
            }

            if (!nextDateStr) return '';
            
            const nextDate = new Date(nextDateStr);
            const now = new Date();
            
            // 重置时间部分，只比较日期，避免因时分秒导致的计算偏差
            // Reset time part, only compare dates
            nextDate.setHours(0,0,0,0);
            now.setHours(0,0,0,0);

            let diffTime = nextDate - now;
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // 处理已过期的情况
            // Handle overdue cases
            if (diffDays < 0) {
                return `
                    <div class="battery-container" title="Overdue">
                        <div class="battery" style="border-color: #666;">
                            <div class="battery-level" style="width: 0%; background: #666;" data-width="0%"></div>
                        </div>
                        <span class="days-left" style="color:#666">Exp</span>
                    </div>
                `;
            }

            // 估算周期长度（天）用于计算百分比
            // Estimate cycle length (days) for percentage calculation
            const cycleDays = frequency === 12 ? 365 : 30;
            
            // 计算百分比 (剩余天数 / 周期)
            // Calculate percentage (days left / cycle)
            let percentage = (diffDays / cycleDays) * 100;
            if (percentage > 100) percentage = 100; // 防止新续费时溢出
            
            // 根据剩余电量确定颜色 (绿 -> 橙 -> 红)
            // Determine color based on level
            let color = '#4caf50'; // Green
            if (percentage < 20) {
                color = '#f44336'; // Red
            } else if (percentage < 50) {
                color = '#ff9800'; // Orange
            }

            return `
                <div class="battery-container" title="${diffDays} days left">
                    <div class="battery">
                        <!-- data-width 用于 JS 动画 -->
                        <div class="battery-level" style="background: ${color}; width: 0%" data-width="${percentage}%"></div>
                    </div>
                    <span class="days-left">${diffDays}d</span>
                </div>
            `;
        }

        /**
         * 获取订阅图标 URL
         * Get Subscription Logo URL
         * 
         * 逻辑：
         * 1. 如果数据库中有 logo 字段，直接使用
         * 2. 如果有 url 字段，提取域名并调用 Clearbit API
         * 3. 如果只有 name，尝试猜测域名 (name + .com) 并调用 Clearbit API
         * 
         * Logic:
         * 1. Use DB logo if available.
         * 2. If url exists, extract domain and use Clearbit API.
         * 3. If only name, guess domain (name.com) and use Clearbit API.
         */
        function getLogoUrl(sub) {
            // 1. 优先使用已保存的 Logo
            if (sub.logo && sub.logo.trim() !== '') {
                return sub.logo;
            }

            let domain = '';

            // 2. 尝试从 URL 提取域名
            if (sub.url && sub.url.trim() !== '') {
                try {
                    // 处理没有 http 前缀的情况
                    let urlStr = sub.url;
                    if (!urlStr.startsWith('http')) {
                        urlStr = 'https://' + urlStr;
                    }
                    const urlObj = new URL(urlStr);
                    domain = urlObj.hostname;
                    
                    // 修正：如果域名不包含点（例如用户只输入了 "icloud"），自动补全 .com
                    // Fix: If domain has no dot (e.g. user entered "icloud"), append .com
                    if (domain && !domain.includes('.')) {
                        domain += '.com';
                    }
                } catch (e) {
                    console.warn("Invalid URL:", sub.url);
                }
            }

            // 3. 如果没有 URL，根据名称猜测域名
            if (!domain) {
                const cleanName = sub.name.toLowerCase().replace(/\s+/g, '');
                // 默认猜测：名称 + .com
                // Default guess: name + .com
                domain = cleanName + '.com';
            }

            // 使用 Google Favicon 服务作为首选 (更稳定)
            // Use Google Favicon service as primary (more stable)
            return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
        }

        /**
         * 在线搜索公司信息 (调用后端 API)
         * Online search for company info via Backend API
         *
         * 使用 Promise 缓存机制，确保同一个名称只发起一次请求
         * Uses Promise caching to ensure only one request per name
         */
        function searchCompany(name) {
            // 1. 检查缓存中是否已有 Promise
            if (searchCache[name]) {
                return searchCache[name];
            }

            // 2. 创建新的 Promise 并存入缓存
            const promise = (async () => {
                try {
                    const res = await fetch(`/api/search?q=${encodeURIComponent(name)}`);
                    if (res.ok) {
                        const data = await res.json();
                        if (data && data.domain) {
                            return {
                                name: name,
                                domain: data.domain,
                                logo: `https://www.google.com/s2/favicons?domain=${data.domain}&sz=64`
                            };
                        }
                    }
                } catch (e) {
                    console.warn("Company search failed:", e);
                }
                return null;
            })();

            searchCache[name] = promise;
            return promise;
        }

        /**
         * 计算并显示统计数据
         * Calculate and display statistics
         */
        function renderStats(subs) {
            let total = 0;
            // 简单取第一个订阅的货币单位，实际应用可能需要更复杂的货币转换逻辑
            // Simply use the currency of the first subscription
            let currency = subs.length > 0 ? subs[0].currency : 'CNY';
            
            subs.forEach(sub => {
                // 忽略永久订阅 (不计入月费)
                // Ignore lifetime subscriptions (not counted in monthly cost)
                if (sub.frequency === 0) return;

                // 将年付金额分摊到每月
                // Amortize yearly payments to monthly
                if(sub.frequency === 12) {
                    total += sub.price / 12;
                } else {
                    total += sub.price;
                }
            });
            document.getElementById('total-cost').innerText = currency + ' ' + total.toFixed(2);
            document.getElementById('active-count').innerText = subs.length;
        }

        /**
         * 切换永久订阅状态
         * Toggle Lifetime Subscription status
         */
        function toggleLifetime() {
            const isLifetime = document.getElementById('lifetime').checked;
            const freqSelect = document.getElementById('frequency');
            const dateInput = document.getElementById('next_payment');
            const priceInput = document.getElementById('price');

            if (isLifetime) {
                freqSelect.disabled = true;
                freqSelect.style.opacity = '0.5';
                
                dateInput.disabled = true;
                dateInput.style.opacity = '0.5';
                dateInput.value = ''; // Clear date
                
                priceInput.placeholder = "Price (Optional for Lifetime)";
            } else {
                freqSelect.disabled = false;
                freqSelect.style.opacity = '1';
                
                dateInput.disabled = false;
                dateInput.style.opacity = '1';
                
                priceInput.placeholder = "Price";
            }
            clearError();
        }

        /**
         * 添加新订阅
         * Add new subscription
         */
        async function addSubscription() {
            const btnSave = document.getElementById('btn-save');
            const nameInput = document.getElementById('name');
            const priceInput = document.getElementById('price');
            const dateInput = document.getElementById('next_payment');
            const isLifetime = document.getElementById('lifetime').checked;
            
            // Clear previous errors
            clearError();
            
            let hasError = false;
            
            // 1. Validate Name
            if (!nameInput.value || nameInput.value.trim() === '') {
                nameInput.classList.add('input-error');
                document.getElementById('name-error').style.display = 'block';
                hasError = true;
            }
            
            // 2. Validate Price (Required unless Lifetime)
            // Note: Lifetime allows empty price (backend defaults to 0)
            if (!isLifetime && (!priceInput.value || priceInput.value.trim() === '')) {
                priceInput.classList.add('input-error');
                document.getElementById('price-error').style.display = 'block';
                hasError = true;
            }

            // 3. Validate Date (Required unless Lifetime)
            if (!isLifetime && (!dateInput.value || dateInput.value.trim() === '')) {
                dateInput.classList.add('input-error');
                document.getElementById('date-error').style.display = 'block';
                hasError = true;
            }
            
            if (hasError) return;

            const originalBtnText = btnSave.innerText;
            btnSave.disabled = true;
            btnSave.innerText = "Processing...";
            btnSave.style.opacity = "0.7";
            btnSave.style.cursor = "not-allowed";

            try {
                const payload = {
                    name: nameInput.value,
                    price: priceInput.value ? parseFloat(priceInput.value) : null, // Send null if empty
                    currency: document.getElementById('currency').value,
                    next_payment: isLifetime ? null : dateInput.value,
                    frequency: isLifetime ? 0 : parseInt(document.getElementById('frequency').value),
                    url: "", // Removed input, handled by auto-search logic below
                    logo: ""
                };

                // 尝试自动匹配 URL (仅在 Name 变更或 Logo 为空时触发)
                // Try auto-match URL (only if name changed or logo empty)
                if (!isEditMode || !originalLogo) {
                    btnSave.innerText = "Searching Domain...";
                    const companyInfo = await searchCompany(payload.name);

                    if (companyInfo && companyInfo.domain) {
                        payload.url = 'https://' + companyInfo.domain;
                        payload.logo = companyInfo.logo;
                        console.log(`Auto-matched: ${companyInfo.domain}`);
                    }
                } else {
                    // 编辑模式下，如果没重新搜索，保持原有 Logo
                    // In edit mode, keep original logo if not re-searched
                    payload.logo = originalLogo;
                }

                btnSave.innerText = isEditMode ? "Updating..." : "Saving...";
                
                const url = isEditMode ? `${API}/${editId}` : API;
                const method = isEditMode ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    alert(`Error ${isEditMode ? 'updating' : 'adding'} subscription: ` + errorText);
                    return;
                }

                closeModal();
                fetchSubs(); 
            } catch (error) {
                console.error("Error:", error);
                alert("An unexpected error occurred.");
            } finally {
                btnSave.disabled = false;
                btnSave.innerText = originalBtnText; // Restore original text (Save/Update)
                btnSave.style.opacity = "1";
                btnSave.style.cursor = "pointer";
            }
        }

        // ==============================
        // 删除功能相关的逻辑 (Delete Logic)
        // ==============================
        let deleteTargetId = null;
        let deleteTargetName = '';

        /**
         * 打开删除确认模态框
         * Open delete confirmation modal
         */
        function openDeleteModal(id) {
            // 在全局数据中查找该订阅
            const sub = currentSubs.find(s => s.id === id);
            if(!sub) return;

            deleteTargetId = id;
            deleteTargetName = sub.name;

            // 更新 UI
            document.getElementById('delete-match-name').innerText = sub.name;
            const input = document.getElementById('delete-confirm-input');
            input.value = ''; // 清空输入框
            
            // 重置删除按钮状态（禁用）
            const btn = document.getElementById('btn-confirm-delete');
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';

            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            deleteTargetId = null;
            deleteTargetName = '';
        }

        // 监听输入框，匹配订阅名称
        // Listen to input to match subscription name
        document.getElementById('delete-confirm-input').addEventListener('input', function(e) {
            const val = e.target.value;
            const btn = document.getElementById('btn-confirm-delete');
            
            // 只有输入内容完全匹配订阅名称时，才启用删除按钮
            // Enable delete button only if input matches name exactly
            if(val === deleteTargetName) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            }
        });

        /**
         * 执行真正的删除操作
         * Execute actual delete operation
         */
        async function executeDelete() {
            if(!deleteTargetId) return;
            await fetch(`${API}/${deleteTargetId}`, { method: 'DELETE' });
            closeDeleteModal();
            fetchSubs(); // 刷新列表
        }

        // 编辑模式状态
        // Edit mode state
        let isEditMode = false;
        let editId = null;
        let originalLogo = "";

        // ==============================
        // 通用模态框控制 (Modal Controls)
        // ==============================
        /**
         * 打开添加/编辑模态框
         * Open Add/Edit Modal
         * @param {number|null} id - 如果提供 ID，则进入编辑模式 (If ID provided, enter edit mode)
         */
        function openModal(id = null) { 
            clearError();
            const modalTitle = document.querySelector('#addModal h2');
            const btnSave = document.getElementById('btn-save');

            if (id) {
                // 编辑模式
                // Edit Mode
                const sub = currentSubs.find(s => s.id === id);
                if (!sub) return;

                isEditMode = true;
                editId = id;
                originalLogo = sub.logo; // 保存原有 Logo，避免编辑时丢失
                
                modalTitle.innerText = "Edit Subscription";
                btnSave.innerText = "Update";

                // 填充表单
                document.getElementById('name').value = sub.name;
                document.getElementById('price').value = sub.price;
                document.getElementById('currency').value = sub.currency;
                
                // 处理 Lifetime
                if (sub.frequency === 0) {
                    document.getElementById('lifetime').checked = true;
                    document.getElementById('frequency').value = 1; // 重置为默认，虽然会被禁用
                    document.getElementById('next_payment').value = '';
                } else {
                    document.getElementById('lifetime').checked = false;
                    document.getElementById('frequency').value = sub.frequency;
                    document.getElementById('next_payment').value = sub.next_payment || '';
                }
                
                toggleLifetime(); // 更新 UI 状态
            } else {
                // 新增模式
                // Add Mode
                isEditMode = false;
                editId = null;
                originalLogo = "";
                
                modalTitle.innerText = "New Subscription";
                btnSave.innerText = "Save";

                // 重置表单
                document.getElementById('name').value = '';
                document.getElementById('price').value = '';
                document.getElementById('currency').value = 'CNY';
                document.getElementById('lifetime').checked = false;
                document.getElementById('frequency').value = 1;
                document.getElementById('next_payment').value = '';
                
                toggleLifetime(); 
            }
            
            // 显示模态框
            document.getElementById('addModal').style.display = 'block'; 
        }
        
        function closeModal() { 
            document.getElementById('addModal').style.display = 'none'; 
        }
        
        // 清除表单错误样式
        // Clear form error styles
        function clearError() {
            // Name
            document.getElementById('name').classList.remove('input-error');
            document.getElementById('name-error').style.display = 'none';
            
            // Price
            document.getElementById('price').classList.remove('input-error');
            document.getElementById('price-error').style.display = 'none';
            
            // Date
            document.getElementById('next_payment').classList.remove('input-error');
            document.getElementById('date-error').style.display = 'none';
        }

        // 页面加载完成后立即获取数据
        // Fetch data immediately on page load
        fetchSubs();
    </script>
</body>
</html>
